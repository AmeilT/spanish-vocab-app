<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Vocab Master: Ciudades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-lg bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 relative h-[600px] flex flex-col">
        
        <!-- Header / Progress -->
        <div id="header-section" class="bg-indigo-600 p-6 text-white hidden flex-shrink-0">
            <div class="flex justify-between items-center mb-2">
                <span class="font-bold text-lg"><i class="fas fa-city mr-2"></i>Ciudades Quiz</span>
                <div class="flex items-center space-x-4">
                    <span class="bg-indigo-500 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-fire text-orange-400 mr-1"></i> <span id="streak-display">0</span>
                    </span>
                    <span class="font-semibold text-indigo-100" id="score-display">0/0</span>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="w-full bg-indigo-800 rounded-full h-2 mt-2">
                <div id="progress-bar" class="bg-teal-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Screens -->
        <div class="flex-grow flex flex-col relative overflow-hidden">
            
            <!-- 1. Start Screen (Simplified Menu) -->
            <div id="start-screen" class="absolute inset-0 p-8 flex flex-col justify-center items-center bg-white z-20 fade-in overflow-y-auto">
                <div class="bg-indigo-100 p-6 rounded-full mb-6 text-indigo-600 flex-shrink-0">
                    <i class="fas fa-building text-5xl"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2 text-slate-800 flex-shrink-0">Unit: Ciudades</h1>
                <p class="text-slate-500 mb-6 text-center text-sm flex-shrink-0">Vocabulary, adjectives, and expressions for describing cities.</p>
                
                <!-- Action Buttons -->
                <div class="space-y-3 w-full max-w-xs flex-shrink-0">
                    <button onclick="quickStartGame()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-colors shadow-lg shadow-indigo-200">
                        Quick Start (10 Questions)
                    </button>
                    
                    <!-- Button to access Configuration Screen -->
                    <button onclick="showConfigScreen()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 px-6 rounded-xl transition-colors flex justify-center items-center">
                        <i class="fas fa-sliders-h mr-2"></i> Configure & Start
                    </button>

                    <button onclick="showListScreen()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 px-6 rounded-xl transition-colors flex justify-center items-center">
                        <i class="fas fa-list-ul mr-2"></i> Study List
                    </button>
                </div>
            </div>

            <!-- 2. Configuration Screen (Mode, Category, & Length Selection) -->
            <div id="config-screen" class="absolute inset-0 flex flex-col bg-white z-20 hidden fade-in">
                <div class="bg-indigo-600 text-white p-4 flex justify-between items-center flex-shrink-0">
                    <button onclick="showStartScreen()" class="text-white hover:text-indigo-200 font-medium">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>
                    <h2 class="font-bold text-lg">Quiz Settings</h2>
                    <div></div> <!-- Spacer -->
                </div>
                <div class="p-6 flex flex-col flex-grow overflow-y-auto">
                    
                    <!-- QUIZ LENGTH SELECTION -->
                    <div class="w-full mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200 flex-shrink-0">
                        <h3 class="text-sm font-bold text-slate-600 mb-3 uppercase tracking-wider text-center">Quiz Length</h3>
                        <select id="quiz-length-select" class="w-full bg-white border border-slate-300 rounded-lg p-2 text-slate-700 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="10">10 Questions (Quick)</option>
                            <option value="25">25 Questions (Challenge)</option>
                            <option value="999">All Vocab</option>
                        </select>
                    </div>

                    <!-- MODE SELECTION -->
                    <div class="w-full mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200 flex-shrink-0">
                        <h3 class="text-sm font-bold text-slate-600 mb-3 uppercase tracking-wider text-center">Quiz Mode</h3>
                        <div class="flex space-x-4 justify-center">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="quiz-mode" value="spelling" checked class="text-indigo-600 focus:ring-indigo-500 rounded-full">
                                <span class="text-sm text-slate-700 font-medium">Spelling</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="quiz-mode" value="multiple-choice" class="text-indigo-600 focus:ring-indigo-500 rounded-full">
                                <span class="text-sm text-slate-700 font-medium">Multiple Choice</span>
                            </label>
                        </div>
                    </div>

                    <!-- CATEGORY SELECTION -->
                    <div class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 flex-grow flex flex-col min-h-[150px]">
                        <h3 class="text-sm font-bold text-slate-600 mb-3 uppercase tracking-wider flex-shrink-0">Select Categories</h3>
                        <div id="category-selector" class="grid grid-cols-2 gap-y-3 gap-x-4 text-sm flex-grow overflow-y-auto pr-2">
                            <!-- Checkboxes will be injected here by JS -->
                        </div>
                        <div class="mt-4 pt-3 border-t border-slate-200 flex-shrink-0">
                            <label class="flex items-center space-x-2 text-indigo-600 cursor-pointer">
                                <input type="checkbox" id="select-all-categories" checked class="text-indigo-600 focus:ring-indigo-500 rounded">
                                <span class="text-sm font-semibold">Select All</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Final Action Button for Config Screen -->
                <div class="p-6 pt-0 flex-shrink-0">
                    <button onclick="applyConfigAndStartGame()" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-teal-200 transition-all transform active:scale-95">
                        Start Quiz <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>


            <!-- 3. Study List Screen -->
            <div id="list-screen" class="absolute inset-0 flex flex-col bg-white z-20 hidden fade-in">
                <div class="bg-slate-50 border-b border-slate-200 p-4 flex justify-between items-center flex-shrink-0">
                    <h2 class="font-bold text-lg text-slate-700">Vocabulary List</h2>
                    <button onclick="showStartScreen()" class="text-indigo-600 font-medium hover:text-indigo-800">
                        Close <i class="fas fa-times ml-1"></i>
                    </button>
                </div>
                <div id="vocab-list-container" class="flex-grow overflow-y-auto p-4 space-y-6">
                    <!-- Content injected via JS -->
                </div>
            </div>

            <!-- 4. Game Screen -->
            <div id="game-screen" class="hidden flex-col h-full justify-between fade-in p-8">
                
                <div class="text-center mt-4 flex-shrink-0">
                    <p class="text-sm text-slate-400 font-medium uppercase tracking-wider mb-2">Translate to Spanish</p>
                    <h2 id="question-word" class="text-2xl font-bold text-indigo-900 mb-6 leading-tight">Hello</h2>
                </div>

                <!-- Dynamic Answer Area -->
                <div id="answer-area" class="w-full flex-grow flex flex-col justify-center mb-4">
                    
                    <!-- Spelling Mode Container -->
                    <div id="spelling-mode-container">
                        <div class="relative">
                            <input type="text" id="answer-input" 
                                class="w-full bg-slate-50 border-2 border-slate-200 text-slate-800 text-lg font-medium rounded-xl p-4 text-center focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all placeholder-slate-300"
                                placeholder="Type translation..." autocomplete="off">
                            
                            <!-- Feedback Icons -->
                            <div id="feedback-icon" class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 text-xl"></div>
                        </div>

                        <!-- Accent Helper Keys -->
                        <div class="flex justify-center flex-wrap gap-2 mt-4" id="accent-keys">
                            <button onclick="addChar('√°')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">√°</button>
                            <button onclick="addChar('√©')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">√©</button>
                            <button onclick="addChar('√≠')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">√≠</button>
                            <button onclick="addChar('√≥')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">√≥</button>
                            <button onclick="addChar('√∫')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">√∫</button>
                            <button onclick="addChar('√±')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">√±</button>
                        </div>

                        <!-- Message Area -->
                        <div id="message-area" class="h-16 mt-4 flex items-center justify-center text-center font-medium"></div>
                    </div>

                    <!-- Multiple Choice Mode Container -->
                    <div id="mc-mode-container" class="hidden flex flex-col space-y-3 pt-4 overflow-y-auto max-h-full">
                        <!-- Multiple choice options will be injected here -->
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="w-full mt-auto flex-shrink-0">
                    <div class="mt-2" id="action-buttons-container">
                        <button id="submit-btn" onclick="checkAnswer()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 transition-all transform active:scale-95">
                            Check Answer
                        </button>
                        <button id="next-btn" onclick="nextQuestion()" class="hidden w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-teal-200 transition-all transform active:scale-95">
                            Next Question <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 5. Result Screen -->
            <div id="result-screen" class="hidden text-center fade-in absolute inset-0 bg-white p-8 flex flex-col justify-center items-center z-10 overflow-y-auto">
                <div id="result-emoji" class="text-6xl mb-4">üéâ</div>
                <h2 class="text-3xl font-bold text-slate-800 mb-2">Quiz Complete!</h2>
                <p class="text-slate-500 mb-6">Here is how you did:</p>
                
                <div class="grid grid-cols-2 gap-4 w-full mb-8">
                    <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                        <div class="text-3xl font-bold text-indigo-600" id="final-score">0</div>
                        <div class="text-xs text-indigo-400 uppercase font-bold tracking-wide">Score</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100">
                        <div class="text-3xl font-bold text-orange-500" id="final-accuracy">0%</div>
                        <div class="text-xs text-orange-400 uppercase font-bold tracking-wide">Accuracy</div>
                    </div>
                </div>

                <div class="w-full space-y-3">
                    <button onclick="resetGame()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg">
                        Play Again
                    </button>
                    <button onclick="showStartScreen()" class="w-full text-slate-500 hover:text-indigo-600 font-medium py-3 transition-colors">
                        Back to Menu
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-center text-slate-400 text-sm">
        <p>Tip: Punctuation is ignored.</p>
    </div>

    <script>
        // Structured Data for Categories
        const groupedVocab = {
            "Adjetivos: Positivos": [
                { en: "beautiful / lovely", es: ["preciosa"] },
                { en: "well looked-after", es: ["cuidada"] },
                { en: "clean", es: ["limpia"] },
                { en: "grand / full of monuments", es: ["monumental"] },
                { en: "calm / peaceful", es: ["tranquila"] },
                { en: "traditional", es: ["tradicional"] },
                { en: "artistic", es: ["art√≠stica"] },
                { en: "historic", es: ["hist√≥rica"] },
                { en: "well preserved", es: ["bien conservada", "conservada"] },
                { en: "cosmopolitan / international", es: ["cosmopolita"] },
                { en: "lively / vibrant", es: ["viva", "vibrante"] },
                { en: "special", es: ["especial"] },
                { en: "well organised", es: ["bien organizada", "organizada"] },
                { en: "open-minded / open", es: ["abierta"] }
            ],
            "Adjetivos: Negativos": [
                { en: "horrible", es: ["horrible"] },
                { en: "messy / disorganised", es: ["desordenada", "desorganizada"] },
                { en: "dirty", es: ["sucia"] },
                { en: "noisy", es: ["ruidosa"] },
                { en: "boring", es: ["aburrida"] },
                { en: "polluted", es: ["contaminada"] },
                { en: "run-down / decaying", es: ["decadente"] },
                { en: "badly preserved", es: ["mal conservada"] },
                { en: "dangerous", es: ["peligrosa"] },
                { en: "closed / narrow-minded", es: ["cerrada"] }
            ],
            "Adjetivos: Neutrales": [
                { en: "human / people-focused", es: ["humana"] },
                { en: "cheerful / lively", es: ["alegre"] },
                { en: "old / traditional", es: ["antigua"] },
                { en: "urban", es: ["urbana"] }
            ],
            "Vocabulario Clave": [
                { en: "traffic", es: ["el tr√°fico", "tr√°fico"] },
                { en: "overpopulation", es: ["la superpoblaci√≥n", "superpoblaci√≥n"] },
                { en: "coexistence", es: ["la convivencia", "convivencia"] },
                { en: "chaos", es: ["el caos", "caos"] },
                { en: "pollution", es: ["la contaminaci√≥n", "contaminaci√≥n"] },
                { en: "atmosphere / vibe", es: ["el ambiente", "ambiente"] },
                { en: "aggressive side", es: ["la parte agresiva"] },
                { en: "awake city / always active", es: ["ciudad despierta"] },
                { en: "never sleeps", es: ["no duerme"] },
                { en: "to connect with others", es: ["relacionarse"] },
                { en: "to have a few glasses of wine", es: ["tomar unos vinos"] },
                { en: "the bar on the corner", es: ["el bar de la esquina"] },
                { en: "neighbourhood", es: ["barrio", "el barrio"] },
                { en: "welcoming", es: ["acogedora"] }
            ],
            "Expresiones: Opiniones": [
                { en: "In my opinion...", es: ["en mi opini√≥n"] },
                { en: "I think that...", es: ["creo que"] },
                { en: "It seems to me that...", es: ["me parece que"] },
                { en: "From my point of view...", es: ["desde mi punto de vista"] },
                { en: "I agree", es: ["estoy de acuerdo"] },
                { en: "You're right", es: ["tienes raz√≥n"] },
                { en: "I share your opinion", es: ["comparto tu opini√≥n"] },
                { en: "I disagree", es: ["no estoy de acuerdo"] },
                { en: "I don't see it that way", es: ["no lo veo as√≠"] },
                { en: "I think you're mistaken", es: ["creo que te equivocas"] }
            ],
            "Expresiones: Contraste": [
                { en: "On one hand...", es: ["por un lado", "por una parte"] },
                { en: "On the other hand...", es: ["por otro lado", "por otra parte"] },
                { en: "Despite...", es: ["a pesar de"] },
                { en: "Although / even though...", es: ["aunque"] },
                { en: "However / nevertheless...", es: ["sin embargo"] }
            ],
            "Frases √ötiles": [
                { en: "What I like most is...", es: ["lo que m√°s me gusta es"] },
                { en: "It's a welcoming city", es: ["es una ciudad acogedora"] },
                { en: "It has a warm atmosphere", es: ["tiene un ambiente muy c√°lido"] },
                { en: "It's very cosmopolitan", es: ["es muy cosmopolita"] },
                { en: "The worst thing is...", es: ["lo peor de la ciudad es", "lo peor es"] },
                { en: "It's too noisy", es: ["es demasiado ruidosa"] },
                { en: "There are too many people", es: ["hay demasiada gente"] },
                { en: "The traffic is unbearable", es: ["el tr√°fico es insoportable"] },
                { en: "It has good and bad things", es: ["tiene cosas buenas y malas"] },
                { en: "It's a city that never sleeps", es: ["es una ciudad que nunca duerme"] }
            ],
            "Estructuras": [
                { en: "The good thing is that...", es: ["lo bueno es que"] },
                { en: "The bad thing is that...", es: ["lo malo es que"] },
                { en: "It's a city where...", es: ["es una ciudad donde"] },
                { en: "It's a place in which...", es: ["es un lugar en el que"] }
            ]
        };

        // State Variables
        let currentQueue = [];
        let currentIndex = 0;
        let score = 0;
        let streak = 0;
        let isAnswered = false;
        let quizMode = 'spelling'; 
        let selectedCategories = Object.keys(groupedVocab); 
        let quizLength = 10; // Default length

        // DOM Elements
        const screens = {
            start: document.getElementById('start-screen'),
            config: document.getElementById('config-screen'), 
            game: document.getElementById('game-screen'),
            result: document.getElementById('result-screen'),
            list: document.getElementById('list-screen'),
            header: document.getElementById('header-section')
        };
        const els = {
            questionWord: document.getElementById('question-word'),
            input: document.getElementById('answer-input'),
            submitBtn: document.getElementById('submit-btn'),
            nextBtn: document.getElementById('next-btn'),
            feedbackIcon: document.getElementById('feedback-icon'),
            messageArea: document.getElementById('message-area'),
            scoreDisplay: document.getElementById('score-display'),
            streakDisplay: document.getElementById('streak-display'),
            progressBar: document.getElementById('progress-bar'),
            finalScore: document.getElementById('final-score'),
            finalAccuracy: document.getElementById('final-accuracy'),
            resultEmoji: document.getElementById('result-emoji'),
            vocabListContainer: document.getElementById('vocab-list-container'),
            categorySelector: document.getElementById('category-selector'),
            spellingContainer: document.getElementById('spelling-mode-container'),
            mcContainer: document.getElementById('mc-mode-container'),
            accentKeys: document.getElementById('accent-keys'),
            selectAllCheckbox: null, 
            quizLengthSelect: document.getElementById('quiz-length-select') 
        };

        // --- Setup Logic for Category Checkboxes ---

        function renderCategoryCheckboxes() {
            const keys = Object.keys(groupedVocab);
            els.categorySelector.innerHTML = keys.map(key => `
                <label class="flex items-center space-x-2 text-slate-700 cursor-pointer">
                    <input type="checkbox" name="category" value="${key}" 
                           ${selectedCategories.includes(key) ? 'checked' : ''} 
                           class="category-checkbox text-indigo-600 focus:ring-indigo-500 rounded">
                    <span class="text-sm">${key}</span>
                </label>
            `).join('');

            // Set up "Select All" functionality
            els.selectAllCheckbox = document.getElementById('select-all-categories');
            if (els.selectAllCheckbox) {
                 // Check if all are selected based on initial state
                 els.selectAllCheckbox.checked = selectedCategories.length === keys.length;
                 els.selectAllCheckbox.addEventListener('change', (e) => {
                    document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });
                
                // Add event listener to category checkboxes to update 'Select All' state
                document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateSelectAllState);
                });
            }

            // Set up initial mode state
            const modeRadio = document.querySelector(`input[name="quiz-mode"][value="${quizMode}"]`);
            if(modeRadio) modeRadio.checked = true;

            // Set up initial length state
            if (els.quizLengthSelect) {
                els.quizLengthSelect.value = quizLength.toString();
            }
        }
        
        function updateSelectAllState() {
            const total = document.querySelectorAll('.category-checkbox').length;
            const checked = document.querySelectorAll('.category-checkbox:checked').length;
            if (els.selectAllCheckbox) {
                els.selectAllCheckbox.checked = total === checked;
            }
        }


        // Initialize checkboxes when the page loads
        document.addEventListener('DOMContentLoaded', renderCategoryCheckboxes);

        // --- Data & Utility Functions ---

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function normalizeText(text) {
            return text.toLowerCase()
                       .replace(/[.,;...¬°!¬ø?]/g, "") 
                       .replace(/\s+/g, " ")         
                       .trim();
        }

        function updateStats() {
            els.scoreDisplay.textContent = `${score}/${currentQueue.length}`;
            els.streakDisplay.textContent = streak;
            const progress = ((currentIndex) / currentQueue.length) * 100;
            els.progressBar.style.width = `${progress}%`;
        }

        function shakeInput() {
            if (quizMode === 'spelling') {
                els.input.classList.add('shake');
                setTimeout(() => {
                    els.input.classList.remove('shake');
                }, 500);
            }
        }

        // --- Navigation Functions ---

        function hideAllScreens() {
            Object.values(screens).forEach(screen => {
                screen.classList.add('hidden');
                screen.classList.remove('flex'); 
            });
        }
        
        function showListScreen() {
            hideAllScreens();
            screens.list.classList.remove('hidden');
            screens.list.classList.add('flex');
            renderVocabList();
        }

        function showStartScreen() {
            hideAllScreens();
            screens.header.classList.add('hidden');
            screens.start.classList.remove('hidden');
            screens.start.classList.add('flex');
        }

        function showConfigScreen() {
            hideAllScreens();
            screens.config.classList.remove('hidden');
            screens.config.classList.add('flex');
            renderCategoryCheckboxes(); // Ensure current selection is displayed
        }

        function quickStartGame() {
            // Set default configuration for quick start
            quizMode = 'spelling';
            quizLength = 10;
            selectedCategories = Object.keys(groupedVocab);
            startGame(quizLength);
        }

        function applyConfigAndStartGame() {
             // 1. Get Selected Categories
            selectedCategories = Array.from(document.querySelectorAll('.category-checkbox:checked')).map(cb => cb.value);

            // 2. Get Quiz Mode
            const selectedMode = document.querySelector('input[name="quiz-mode"]:checked');
            quizMode = selectedMode ? selectedMode.value : 'spelling'; 

            // 3. Get Quiz Length
            quizLength = parseInt(els.quizLengthSelect.value, 10);

            if (selectedCategories.length === 0) {
                alertUser('Please select at least one category.', 'text-red-500');
                return;
            }

            startGame(quizLength);
        }

        function startGame(count) {
            
            // Filter the database based on selected categories
            let filteredVocab = [];
            selectedCategories.forEach(categoryKey => {
                if (groupedVocab[categoryKey]) {
                    filteredVocab.push(...groupedVocab[categoryKey]);
                }
            });

            const maxCount = filteredVocab.length;
            const finalCount = count === 999 ? maxCount : Math.min(count, maxCount);

            if (finalCount === 0) {
                 alertUser('No vocabulary found for the selected categories.', 'text-red-500');
                 return;
            }

            const shuffled = shuffle(filteredVocab);
            currentQueue = shuffled.slice(0, finalCount);
            
            currentIndex = 0;
            score = 0;
            streak = 0;
            isAnswered = false;

            // Update UI visibility
            hideAllScreens();
            screens.game.classList.remove('hidden');
            screens.game.classList.add('flex');
            screens.header.classList.remove('hidden');
            
            updateStats();
            loadQuestion();
        }

        function resetGame() {
            // Restart with the current configuration
            startGame(currentQueue.length);
        }
        
        function alertUser(message, className = 'text-red-500') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 rounded-xl shadow-2xl z-50 bg-white border border-slate-200 ${className} font-semibold fade-in`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // --- Quiz Flow Logic ---

        function generateMultipleChoiceOptions(currentItem) {
            const correctTranslation = currentItem.es[0];
            
            // Filter the database to only include words from selected categories
            let filteredVocabForDistractors = [];
            selectedCategories.forEach(categoryKey => {
                if (groupedVocab[categoryKey]) {
                    filteredVocabForDistractors.push(...groupedVocab[categoryKey]);
                }
            });
            
            const allTranslations = filteredVocabForDistractors.map(item => item.es[0]);
            
            // Filter out the correct answer and any potential synonyms
            const correctNormalized = currentItem.es.map(s => normalizeText(s));

            const incorrectOptions = allTranslations.filter(ans => {
                const normalizedAns = normalizeText(ans);
                // Only keep options that are NOT one of the correct answers
                return !correctNormalized.includes(normalizedAns);
            });
            
            // Shuffle and pick up to 3 distractors
            const distractors = shuffle(incorrectOptions).slice(0, 3);
            
            let options = [...distractors, correctTranslation];
            
            // Ensure we have exactly 4 options by padding with placeholders if necessary
            while (options.length < 4) {
                // Find a random word from the whole database that isn't the correct answer
                const randomWord = shuffle(Object.values(groupedVocab).flat()).find(item => !correctNormalized.includes(normalizeText(item.es[0])));
                if (randomWord) {
                     options.push(randomWord.es[0]);
                } else {
                     options.push("...?"); 
                }
            }

            // Remove duplicates and shuffle
            options = Array.from(new Set(options));
            options = options.slice(0, 4); // Trim back to 4 if duplicates were removed

            return shuffle(options);
        }

        function loadQuestion() {
            isAnswered = false;
            const item = currentQueue[currentIndex];
            
            els.questionWord.textContent = item.en;
            els.input.value = "";
            els.input.disabled = false;
            els.input.classList.remove('border-red-500', 'border-green-500', 'text-green-600', 'text-red-600');
            els.input.classList.add('border-slate-200', 'text-slate-800');
            
            els.submitBtn.classList.remove('hidden');
            els.nextBtn.classList.add('hidden');
            els.feedbackIcon.classList.add('hidden');
            els.messageArea.innerHTML = "";
            
            // Mode-specific display logic
            if (quizMode === 'spelling') {
                els.spellingContainer.classList.remove('hidden');
                els.mcContainer.classList.add('hidden');
                els.submitBtn.style.display = 'block';
                els.input.focus();
            } else { // multiple-choice
                els.spellingContainer.classList.add('hidden');
                els.mcContainer.classList.remove('hidden');
                els.submitBtn.style.display = 'none'; // Submit button is irrelevant in MC
                renderMultipleChoiceOptions(item);
            }
            
            updateStats();
        }

        function renderMultipleChoiceOptions(item) {
            els.mcContainer.innerHTML = ''; // Clear previous options
            const options = generateMultipleChoiceOptions(item);

            options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = `mc-option-btn w-full text-left font-semibold py-3 px-4 rounded-xl transition-all 
                                 bg-slate-100 hover:bg-indigo-50 hover:border-indigo-400 border-2 border-slate-200 text-slate-700`;
                btn.textContent = `${index + 1}. ${option}`;
                btn.setAttribute('data-answer', option);
                btn.onclick = () => selectOption(option);
                els.mcContainer.appendChild(btn);
            });
        }

        function selectOption(selectedTranslation) {
            if (isAnswered) return;
            
            isAnswered = true;
            const currentItem = currentQueue[currentIndex];
            const correctAnswers = currentItem.es.map(s => normalizeText(s));
            const selectedCleaned = normalizeText(selectedTranslation);

            const isCorrect = correctAnswers.includes(selectedCleaned);
            
            // Visually highlight all options
            document.querySelectorAll('.mc-option-btn').forEach(btn => {
                btn.disabled = true;
                const btnAnswerCleaned = normalizeText(btn.getAttribute('data-answer'));
                
                if (correctAnswers.includes(btnAnswerCleaned)) {
                    // Correct answer
                    btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'shadow-md');
                    btn.classList.remove('bg-slate-100', 'hover:bg-indigo-50');
                } else if (btnAnswerCleaned === selectedCleaned) {
                    // Incorrect selected answer
                    btn.classList.add('bg-red-100', 'border-red-500', 'text-red-800', 'shadow-md');
                    btn.classList.remove('bg-slate-100', 'hover:bg-indigo-50');
                } else {
                    // Unselected wrong answer
                    btn.classList.add('opacity-50');
                }
            });

            if (isCorrect) {
                handleCorrect();
            } else {
                handleIncorrect(currentItem.es[0]);
            }

            els.nextBtn.classList.remove('hidden');
            els.nextBtn.focus();
        }

        function checkAnswer() {
            if (quizMode === 'multiple-choice') return; // Handled by selectOption

            if (isAnswered) return;
            
            const rawInput = els.input.value;
            const cleanInput = normalizeText(rawInput);
            
            const currentItem = currentQueue[currentIndex];
            const correctAnswers = currentItem.es.map(s => normalizeText(s));

            if (!rawInput) {
                shakeInput();
                return;
            }

            isAnswered = true;
            els.input.disabled = true;

            const isCorrect = correctAnswers.includes(cleanInput);

            if (isCorrect) {
                handleCorrect();
            } else {
                handleIncorrect(currentItem.es[0]);
            }

            els.submitBtn.classList.add('hidden');
            els.nextBtn.classList.remove('hidden');
            els.nextBtn.focus();
        }

        function handleCorrect() {
            score++;
            streak++;
            
            if (quizMode === 'spelling') {
                els.input.classList.remove('border-slate-200', 'text-slate-800');
                els.input.classList.add('border-green-500', 'text-green-600');
                els.feedbackIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                els.feedbackIcon.classList.remove('hidden');
            }

            els.messageArea.innerHTML = `<span class="text-green-600 font-bold">¬°Correcto!</span>`;
            
            updateStats();
        }

        function handleIncorrect(correctAnswer) {
            streak = 0;
            
            if (quizMode === 'spelling') {
                els.input.classList.remove('border-slate-200', 'text-slate-800');
                els.input.classList.add('border-red-500', 'text-red-600');
                els.feedbackIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                els.feedbackIcon.classList.remove('hidden');
            }

            els.messageArea.innerHTML = `
                <span class="text-red-500 font-bold block text-sm">Incorrect</span>
                <span class="text-slate-600 text-sm">Answer: <strong class="text-indigo-600 text-lg">${correctAnswer}</strong></span>
            `;

            updateStats();
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < currentQueue.length) {
                loadQuestion();
            } else {
                endGame();
            }
        }

        function endGame() {
            hideAllScreens();
            screens.result.classList.remove('hidden');

            const percentage = Math.round((score / currentQueue.length) * 100);
            
            els.finalScore.textContent = `${score} / ${currentQueue.length}`;
            els.finalAccuracy.textContent = `${percentage}%`;

            if (percentage === 100) {
                els.resultEmoji.textContent = "üèÜ";
                els.resultEmoji.classList.add('bounce');
            } else if (percentage >= 80) {
                els.resultEmoji.textContent = "üéâ";
            } else if (percentage >= 50) {
                els.resultEmoji.textContent = "üëç";
            } else {
                els.resultEmoji.textContent = "üìö";
            }
        }
        
        // --- Accent Helper Function ---
        function addChar(char) {
            const input = els.input;
            if (input.disabled || quizMode !== 'spelling') return;
            
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            
            input.value = value.substring(0, start) + char + value.substring(end);
            input.focus();
            input.selectionEnd = start + char.length; 
        }

        // --- Study List Logic ---
        
        function renderVocabList() {
            const container = els.vocabListContainer;
            container.innerHTML = ''; // Clear existing

            for (const [category, items] of Object.entries(groupedVocab)) {
                // Section Header
                const section = document.createElement('div');
                section.className = "mb-6";
                section.innerHTML = `
                    <h3 class="font-bold text-indigo-600 border-b border-indigo-100 pb-2 mb-3 sticky top-0 bg-white z-10">${category}</h3>
                    <div class="grid grid-cols-1 gap-2">
                        ${items.map(item => `
                            <div class="flex justify-between items-start text-sm group hover:bg-slate-50 p-2 rounded transition-colors">
                                <span class="text-slate-600 w-1/2 pr-2">${item.en}</span>
                                <span class="font-medium text-slate-800 w-1/2 text-right">${item.es[0]}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(section);
            }
        }

        // --- Event Listeners ---
        
        // Handle Enter key for spelling mode submission
        els.input.addEventListener("keypress", function(event) {
            if (event.key === "Enter" && quizMode === 'spelling') {
                event.preventDefault();
                checkAnswer();
            }
        });
        
        // Handle Enter key for next question (after answering)
        document.addEventListener("keydown", function(event) {
            // Check if game screen is visible and answer is checked
            if (event.key === "Enter" && isAnswered && !screens.game.classList.contains('hidden')) {
                event.preventDefault();
                nextQuestion();
            }
        });

    </script>
</body>
</html>
