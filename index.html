<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Vocab Master: Ciudades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        /* Style for the answer options */
        .mc-option {
            transition: all 0.2s;
            cursor: pointer;
        }
        .mc-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .correct {
            border-color: #10b981 !important; /* Tailwind teal-500 */
            background-color: #e6fffa !important; /* Tailwind teal-50 */
        }
        .incorrect {
            border-color: #ef4444 !important; /* Tailwind red-500 */
            background-color: #fee2e2 !important; /* Tailwind red-50 */
        }
        .revealed-correct {
            border-color: #2563eb !important; /* Tailwind blue-600 */
            background-color: #eff6ff !important; /* Tailwind blue-50 */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-lg bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 relative h-[600px] flex flex-col">
        
        <!-- Header / Progress -->
        <div id="header-section" class="bg-indigo-600 p-4 text-white hidden flex-shrink-0">
            <div class="flex justify-between items-center mb-2">
                <!-- Back Button -->
                <button onclick="handleGameScreenBack()" class="p-1 rounded-full hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <span class="font-bold text-lg flex-grow text-center">
                    <i class="fas fa-city mr-2"></i>Ciudades Quiz
                </span>
                <div class="flex items-center space-x-4">
                    <span class="bg-indigo-500 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-fire text-orange-400 mr-1"></i> <span id="streak-display">0</span>
                    </span>
                    <span class="font-semibold text-indigo-100" id="score-display">0/0</span>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="w-full bg-indigo-800 rounded-full h-2 mt-2">
                <div id="progress-bar" class="bg-teal-400 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Screens -->
        <div class="flex-grow flex flex-col relative overflow-hidden">
            
            <!-- 1. Start Screen (Simplified Menu) -->
            <div id="start-screen" class="absolute inset-0 p-8 flex flex-col justify-center items-center bg-white z-20 fade-in overflow-y-auto">
                <div class="bg-indigo-100 p-6 rounded-full mb-6 text-indigo-600 flex-shrink-0">
                    <i class="fas fa-building text-5xl"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2 text-slate-800 flex-shrink-0">Unit: Ciudades</h1>
                <p class="text-slate-500 mb-6 text-center text-sm flex-shrink-0">Vocabulary, adjectives, and expressions for describing cities.</p>
                
                <!-- Action Buttons -->
                <div class="space-y-3 w-full max-w-xs flex-shrink-0">
                    <button onclick="quickStartGame()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-colors shadow-lg shadow-indigo-200">
                        Quick Start (10 Questions)
                    </button>
                    
                    <!-- Button to access Configuration Screen -->
                    <button onclick="showConfigScreen()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 px-6 rounded-xl transition-colors flex justify-center items-center">
                        <i class="fas fa-sliders-h mr-2"></i> Configure & Start
                    </button>

                    <button onclick="showListScreen()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 px-6 rounded-xl transition-colors flex justify-center items-center">
                        <i class="fas fa-list-ul mr-2"></i> Study List
                    </button>
                </div>
            </div>

            <!-- 2. Configuration Screen (Mode, Category, & Length Selection) -->
            <div id="config-screen" class="absolute inset-0 flex flex-col bg-white z-20 hidden fade-in">
                <div class="bg-indigo-600 text-white p-4 flex justify-between items-center flex-shrink-0">
                    <button onclick="showStartScreen()" class="text-white hover:text-indigo-200 font-medium">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>
                    <h2 class="font-bold text-lg">Quiz Settings</h2>
                    <div></div> <!-- Spacer -->
                </div>
                <div class="p-6 flex flex-col flex-grow overflow-y-auto">
                    
                    <!-- QUIZ LENGTH SELECTION -->
                    <div class="w-full mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200 flex-shrink-0">
                        <h3 class="text-sm font-bold text-slate-600 mb-3 uppercase tracking-wider text-center">Quiz Length</h3>
                        <select id="quiz-length-select" class="w-full bg-white border border-slate-300 rounded-lg p-2 text-slate-700 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="10">10 Questions (Quick)</option>
                            <option value="25">25 Questions (Challenge)</option>
                            <option value="999">All Vocab</option>
                        </select>
                    </div>

                    <!-- MODE SELECTION -->
                    <div class="w-full mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200 flex-shrink-0">
                        <h3 class="text-sm font-bold text-slate-600 mb-3 uppercase tracking-wider text-center">Quiz Mode</h3>
                        <div class="flex space-x-4 justify-center">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="quiz-mode" value="spelling" checked class="text-indigo-600 focus:ring-indigo-500 rounded-full">
                                <span class="text-sm text-slate-700 font-medium">Spelling</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="quiz-mode" value="multiple-choice" class="text-indigo-600 focus:ring-indigo-500 rounded-full">
                                <span class="text-sm text-slate-700 font-medium">Multiple Choice</span>
                            </label>
                        </div>
                    </div>

                    <!-- CATEGORY SELECTION -->
                    <div class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 flex-grow flex flex-col min-h-[150px]">
                        <h3 class="text-sm font-bold text-slate-600 mb-3 uppercase tracking-wider flex-shrink-0">Select Categories</h3>
                        <div id="category-selector" class="grid grid-cols-2 gap-y-3 gap-x-4 text-sm flex-grow overflow-y-auto pr-2">
                            <!-- Checkboxes will be injected here by JS -->
                        </div>
                        <div class="mt-4 pt-3 border-t border-slate-200 flex-shrink-0">
                            <label class="flex items-center space-x-2 text-indigo-600 cursor-pointer">
                                <input type="checkbox" id="select-all-categories" checked class="text-indigo-600 focus:ring-indigo-500 rounded">
                                <span class="text-sm font-semibold">Select All</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Final Action Button for Config Screen -->
                <div class="p-6 pt-0 flex-shrink-0">
                    <button onclick="applyConfigAndStartGame()" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-teal-200 transition-all transform active:scale-95">
                        Start Quiz <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>


            <!-- 3. Study List Screen -->
            <div id="list-screen" class="absolute inset-0 flex flex-col bg-white z-20 hidden fade-in">
                <div class="bg-slate-50 border-b border-slate-200 p-4 flex justify-between items-center flex-shrink-0">
                    <h2 class="font-bold text-lg text-slate-700">Vocabulary List</h2>
                    <button onclick="showStartScreen()" class="text-indigo-600 font-medium hover:text-indigo-800">
                        Close <i class="fas fa-times ml-1"></i>
                    </button>
                </div>
                <div id="vocab-list-container" class="flex-grow overflow-y-auto p-4 space-y-6">
                    <!-- Content injected via JS -->
                </div>
            </div>

            <!-- 4. Game Screen -->
            <div id="game-screen" class="hidden flex-col h-full justify-between fade-in p-8">
                
                <div class="text-center mt-4 flex-shrink-0">
                    <p class="text-sm text-slate-400 font-medium uppercase tracking-wider mb-2">Translate to Spanish</p>
                    <h2 id="question-word" class="text-2xl font-bold text-indigo-900 mb-6 leading-tight">Hello</h2>
                </div>

                <!-- Dynamic Answer Area -->
                <div id="answer-area" class="w-full flex-grow flex flex-col justify-center mb-4">
                    
                    <!-- Spelling Mode Container -->
                    <div id="spelling-mode-container">
                         <!-- Hint Button -->
                        <div class="flex justify-center mb-4">
                            <!-- Hint button is now always enabled -->
                            <button id="hint-btn" onclick="showHint()" class="bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-full text-sm transition-colors shadow-md shadow-orange-200 flex items-center">
                                <i class="fas fa-lightbulb mr-2"></i> Hint
                            </button>
                        </div>

                        <div class="relative">
                            <input type="text" id="answer-input" 
                                class="w-full bg-slate-50 border-2 border-slate-200 text-slate-800 text-lg font-medium rounded-xl p-4 text-center focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all placeholder-slate-300"
                                placeholder="Type translation..." autocomplete="off">
                            
                            <!-- Feedback Icons -->
                            <div id="feedback-icon" class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 text-xl"></div>
                        </div>

                        <!-- Accent Helper Keys -->
                        <div class="flex justify-center flex-wrap gap-2 mt-4" id="accent-keys">
                            <button onclick="addChar('Ã¡')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">Ã¡</button>
                            <button onclick="addChar('Ã©')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">Ã©</button>
                            <button onclick="addChar('Ã­')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">Ã­</button>
                            <button onclick="addChar('Ã³')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">Ã³</button>
                            <button onclick="addChar('Ãº')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">Ãº</button>
                            <button onclick="addChar('Ã±')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors border border-slate-200">Ã±</button>
                        </div>

                        <!-- Message Area -->
                        <div id="message-area" class="h-16 mt-4 flex items-center justify-center text-center font-medium"></div>
                    </div>

                    <!-- Multiple Choice Mode Container -->
                    <div id="mc-mode-container" class="hidden flex flex-col space-y-3 pt-4 overflow-y-auto max-h-full">
                        <!-- Multiple choice options will be injected here -->
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="w-full mt-auto flex-shrink-0">
                    <div class="mt-2" id="action-buttons-container">
                        <button id="submit-btn" onclick="checkAnswer()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 transition-all transform active:scale-95">
                            Check Answer
                        </button>
                        <button id="next-btn" onclick="nextQuestion()" class="hidden w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-teal-200 transition-all transform active:scale-95">
                            Next Question <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 5. Result Screen -->
            <div id="result-screen" class="hidden text-center fade-in absolute inset-0 bg-white p-8 flex flex-col justify-center items-center z-10 overflow-y-auto">
                <div id="result-emoji" class="text-6xl mb-4">ðŸŽ‰</div>
                <h2 class="text-3xl font-bold text-slate-800 mb-2">Quiz Complete!</h2>
                <p class="text-slate-500 mb-6">Here is how you did:</p>
                
                <div class="grid grid-cols-2 gap-4 w-full mb-8">
                    <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                        <div class="text-3xl font-bold text-indigo-600" id="final-score">0</div>
                        <div class="text-xs text-indigo-400 uppercase font-bold tracking-wide">Score</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100">
                        <div class="text-3xl font-bold text-orange-500" id="final-accuracy">0%</div>
                        <div class="text-xs text-orange-400 uppercase font-bold tracking-wide">Accuracy</div>
                    </div>
                </div>

                <div class="w-full space-y-3">
                    <button onclick="resetGame()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg">
                        Play Again
                    </button>
                    <button onclick="showStartScreen()" class="w-full text-slate-500 hover:text-indigo-600 font-medium py-3 transition-colors">
                        Back to Menu
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-center text-slate-400 text-sm">
        <p>Tip: Punctuation is ignored. Hints are unlimited in spelling mode. Adjectives accept masculine/feminine forms.</p>
    </div>

    <script>
        // Structured Data for Categories
        // Adjectives now include both masculine and feminine forms for flexibility.
        const groupedVocab = {
            "Adjetivos: Positivos": [
                // preciosa (f) / precioso (m)
                { en: "beautiful / lovely", es: ["preciosa", "precioso"] }, 
                // cuidada (f) / cuidado (m)
                { en: "well looked-after", es: ["cuidada", "cuidado"] }, 
                // limpia (f) / limpio (m)
                { en: "clean", es: ["limpia", "limpio"] }, 
                { en: "grand / full of monuments", es: ["monumental"] }, // Invariant
                // tranquila (f) / tranquilo (m)
                { en: "calm / peaceful", es: ["tranquila", "tranquilo"] }, 
                { en: "traditional", es: ["tradicional"] }, // Invariant
                // artÃ­stica (f) / artÃ­stico (m)
                { en: "artistic", es: ["artÃ­stica", "artÃ­stico"] }, 
                // histÃ³rica (f) / histÃ³rico (m)
                { en: "historic", es: ["histÃ³rica", "histÃ³rico"] }, 
                // bien conservada (f) / bien conservado (m)
                { en: "well preserved", es: ["bien conservada", "bien conservado", "conservada", "conservado"] }, 
                { en: "cosmopolitan / international", es: ["cosmopolita"] }, // Invariant
                // viva (f) / vivo (m)
                { en: "lively / vibrant", es: ["viva", "vivo", "vibrante"] }, // 'vibrante' is invariant
                { en: "special", es: ["especial"] }, // Invariant
                // bien organizada (f) / bien organizado (m)
                { en: "well organised", es: ["bien organizada", "bien organizado", "organizada", "organizado"] }, 
                // abierta (f) / abierto (m)
                { en: "open-minded / open", es: ["abierta", "abierto"] } 
            ],
            "Adjetivos: Negativos": [
                { en: "horrible", es: ["horrible"] }, // Invariant
                // desordenada (f) / desordenado (m) - already included both -organizada/-organizado variants
                { en: "messy / disorganised", es: ["desordenada", "desordenado", "desorganizada", "desorganizado"] }, 
                // sucia (f) / sucio (m)
                { en: "dirty", es: ["sucia", "sucio"] }, 
                // ruidosa (f) / ruidoso (m)
                { en: "noisy", es: ["ruidosa", "ruidoso"] }, 
                // aburrida (f) / aburrido (m)
                { en: "boring", es: ["aburrida", "aburrido"] }, 
                // contaminada (f) / contaminado (m)
                { en: "polluted", es: ["contaminada", "contaminado"] }, 
                { en: "run-down / decaying", es: ["decadente"] }, // Invariant
                // mal conservada (f) / mal conservado (m)
                { en: "badly preserved", es: ["mal conservada", "mal conservado"] }, 
                // peligrosa (f) / peligroso (m)
                { en: "dangerous", es: ["peligrosa", "peligroso"] }, 
                // cerrada (f) / cerrado (m)
                { en: "closed / narrow-minded", es: ["cerrada", "cerrado"] } 
            ],
            "Adjetivos: Neutrales": [
                // humana (f) / humano (m)
                { en: "human / people-focused", es: ["humana", "humano"] }, 
                { en: "cheerful / lively", es: ["alegre"] }, // Invariant
                // antigua (f) / antiguo (m)
                { en: "old / traditional", es: ["antigua", "antiguo"] }, 
                // urbana (f) / urbano (m)
                { en: "urban", es: ["urbana", "urbano"] } 
            ],
            "Vocabulario Clave": [
                { en: "traffic", es: ["el trÃ¡fico", "trÃ¡fico"] },
                { en: "overpopulation", es: ["la superpoblaciÃ³n", "superpoblaciÃ³n"] },
                { en: "coexistence", es: ["la convivencia", "convivencia"] },
                { en: "chaos", es: ["el caos", "caos"] },
                { en: "pollution", es: ["la contaminaciÃ³n", "contaminaciÃ³n"] },
                { en: "atmosphere / vibe", es: ["el ambiente", "ambiente"] },
                { en: "aggressive side", es: ["la parte agresiva"] },
                { en: "awake city / always active", es: ["ciudad despierta"] },
                { en: "never sleeps", es: ["no duerme"] },
                { en: "to connect with others", es: ["relacionarse"] },
                { en: "to have a few glasses of wine", es: ["tomar unos vinos"] },
                { en: "the bar on the corner", es: ["el bar de la esquina"] },
                { en: "neighbourhood", es: ["barrio", "el barrio"] },
                // acogedora (f) / acogedor (m)
                { en: "welcoming", es: ["acogedora", "acogedor"] }
            ],
            "Expresiones: Opiniones": [
                { en: "In my opinion...", es: ["en mi opiniÃ³n"] },
                { en: "I think that...", es: ["creo que"] },
                { en: "It seems to me that...", es: ["me parece que"] },
                { en: "From my point of view...", es: ["desde mi punto de vista"] },
                { en: "I agree", es: ["estoy de acuerdo"] },
                { en: "You're right", es: ["tienes razÃ³n"] },
                { en: "I share your opinion", es: ["comparto tu opiniÃ³n"] },
                { en: "I disagree", es: ["no estoy de acuerdo"] },
                { en: "I don't see it that way", es: ["no lo veo asÃ­"] },
                { en: "I think you're mistaken", es: ["creo que te equivocas"] }
            ],
            "Expresiones: Contraste": [
                { en: "On one hand...", es: ["por un lado", "por una parte"] },
                { en: "On the other hand...", es: ["por otro lado", "por otra parte"] },
                { en: "Despite...", es: ["a pesar de"] },
                { en: "Although / even though...", es: ["aunque"] },
                { en: "However / nevertheless...", es: ["sin embargo"] }
            ],
            "Frases Ãštiles": [
                { en: "What I like most is...", es: ["lo que mÃ¡s me gusta es"] },
                { en: "It's a welcoming city", es: ["es una ciudad acogedora"] },
                { en: "It has a warm atmosphere", es: ["tiene un ambiente muy cÃ¡lido"] },
                { en: "It's very cosmopolitan", es: ["es muy cosmopolita"] },
                { en: "The worst thing is...", es: ["lo peor de la ciudad es", "lo peor es"] },
                { en: "It's too noisy", es: ["es demasiado ruidosa", "es demasiado ruidoso"] }, // Updated
                { en: "There are too many people", es: ["hay demasiada gente"] },
                { en: "The traffic is unbearable", es: ["el trÃ¡fico es insoportable"] },
                { en: "It has good and bad things", es: ["tiene cosas buenas y malas"] },
                { en: "It's a city that never sleeps", es: ["es una ciudad que nunca duerme"] }
            ],
            "Estructuras": [
                { en: "The good thing is that...", es: ["lo bueno es que"] },
                { en: "The bad thing is that...", es: ["lo malo es que"] },
                { en: "It's a city where...", es: ["es una ciudad donde"] },
                { en: "It's a place in which...", es: ["es un lugar en el que"] }
            ]
        };

        // State Variables
        let currentQueue = [];
        let currentIndex = 0;
        let score = 0;
        let streak = 0;
        let isAnswered = false;
        let quizMode = 'spelling'; 
        let selectedCategories = Object.keys(groupedVocab); 
        let quizLength = 10; // Default length

        // DOM Elements
        const screens = {
            start: document.getElementById('start-screen'),
            config: document.getElementById('config-screen'), 
            game: document.getElementById('game-screen'),
            result: document.getElementById('result-screen'),
            list: document.getElementById('list-screen'),
            header: document.getElementById('header-section')
        };
        const els = {
            questionWord: document.getElementById('question-word'),
            input: document.getElementById('answer-input'),
            submitBtn: document.getElementById('submit-btn'),
            nextBtn: document.getElementById('next-btn'),
            feedbackIcon: document.getElementById('feedback-icon'),
            messageArea: document.getElementById('message-area'),
            scoreDisplay: document.getElementById('score-display'),
            streakDisplay: document.getElementById('streak-display'),
            progressBar: document.getElementById('progress-bar'),
            finalScore: document.getElementById('final-score'),
            finalAccuracy: document.getElementById('final-accuracy'),
            resultEmoji: document.getElementById('result-emoji'),
            vocabListContainer: document.getElementById('vocab-list-container'),
            categorySelector: document.getElementById('category-selector'),
            spellingContainer: document.getElementById('spelling-mode-container'),
            mcContainer: document.getElementById('mc-mode-container'),
            accentKeys: document.getElementById('accent-keys'),
            hintBtn: document.getElementById('hint-btn'), 
            selectAllCheckbox: null, 
            quizLengthSelect: document.getElementById('quiz-length-select') 
        };

        // --- Setup Logic for Category Checkboxes ---

        function renderCategoryCheckboxes() {
            const keys = Object.keys(groupedVocab);
            els.categorySelector.innerHTML = keys.map(key => `
                <label class="flex items-center space-x-2 text-slate-700 cursor-pointer">
                    <input type="checkbox" name="category" value="${key}" 
                           ${selectedCategories.includes(key) ? 'checked' : ''} 
                           class="category-checkbox text-indigo-600 focus:ring-indigo-500 rounded">
                    <span class="text-sm">${key}</span>
                </label>
            `).join('');

            // Set up "Select All" functionality
            els.selectAllCheckbox = document.getElementById('select-all-categories');
            if (els.selectAllCheckbox) {
                 // Check if all are selected based on initial state
                 els.selectAllCheckbox.checked = selectedCategories.length === keys.length;
                 els.selectAllCheckbox.addEventListener('change', (e) => {
                    document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });
                
                // Add event listener to category checkboxes to update 'Select All' state
                document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateSelectAllState);
                });
            }

            // Set up initial mode state
            const modeRadio = document.querySelector(`input[name="quiz-mode"][value="${quizMode}"]`);
            if(modeRadio) modeRadio.checked = true;

            // Set up initial length state
            if (els.quizLengthSelect) {
                els.quizLengthSelect.value = quizLength.toString();
            }
        }
        
        function updateSelectAllState() {
            const total = document.querySelectorAll('.category-checkbox').length;
            const checked = document.querySelectorAll('.category-checkbox:checked').length;
            if (els.selectAllCheckbox) {
                els.selectAllCheckbox.checked = total === checked;
            }
        }


        // Initialize checkboxes when the page loads
        document.addEventListener('DOMContentLoaded', renderCategoryCheckboxes);

        // --- Data & Utility Functions ---

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function normalizeText(text) {
            return text.toLowerCase()
                       .replace(/[.,;...Â¡!Â¿?]/g, "") 
                       .replace(/\s+/g, " ")         
                       .trim();
        }

        function updateStats() {
            els.scoreDisplay.textContent = `${score}/${currentQueue.length}`;
            els.streakDisplay.textContent = streak;
            const progress = ((currentIndex) / currentQueue.length) * 100;
            els.progressBar.style.width = `${progress}%`;
        }

        function shakeInput() {
            if (quizMode === 'spelling') {
                els.input.classList.add('shake');
                setTimeout(() => {
                    els.input.classList.remove('shake');
                }, 500);
            }
        }
        
        function alertUser(message, className = 'text-red-500') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 rounded-xl shadow-2xl z-50 bg-white border border-slate-200 ${className} font-semibold fade-in`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // --- Navigation Functions ---

        function hideAllScreens() {
            Object.values(screens).forEach(screen => {
                screen.classList.add('hidden');
                screen.classList.remove('flex'); 
            });
        }
        
        function showListScreen() {
            hideAllScreens();
            screens.list.classList.remove('hidden');
            screens.list.classList.add('flex');
            renderVocabList();
        }

        function showStartScreen() {
            hideAllScreens();
            screens.header.classList.add('hidden');
            screens.start.classList.remove('hidden');
            screens.start.classList.add('flex');
        }

        function showConfigScreen() {
            hideAllScreens();
            screens.config.classList.remove('hidden');
            screens.config.classList.add('flex');
            renderCategoryCheckboxes(); // Ensure current selection is displayed
        }
        
        function handleGameScreenBack() {
            // Simple exit back to the start screen, losing current progress.
            showStartScreen();
            alertUser("Quiz exited. Back to menu.", 'text-slate-600');
        }

        function quickStartGame() {
            // Set default configuration for quick start
            quizMode = 'spelling';
            quizLength = 10;
            selectedCategories = Object.keys(groupedVocab);
            startGame(quizLength);
        }

        function applyConfigAndStartGame() {
             // 1. Get Selected Categories
            selectedCategories = Array.from(document.querySelectorAll('.category-checkbox:checked')).map(cb => cb.value);

            // 2. Get Quiz Mode
            const selectedMode = document.querySelector('input[name="quiz-mode"]:checked');
            quizMode = selectedMode ? selectedMode.value : 'spelling'; 

            // 3. Get Quiz Length
            quizLength = parseInt(els.quizLengthSelect.value, 10);

            if (selectedCategories.length === 0) {
                alertUser('Please select at least one category.', 'text-red-500');
                return;
            }

            startGame(quizLength);
        }

        function startGame(count) {
            
            // Filter the database based on selected categories
            let filteredVocab = [];
            selectedCategories.forEach(categoryKey => {
                if (groupedVocab[categoryKey]) {
                    filteredVocab.push(...groupedVocab[categoryKey]);
                }
            });

            const maxCount = filteredVocab.length;
            const finalCount = count === 999 ? maxCount : Math.min(count, maxCount);

            if (finalCount === 0) {
                 alertUser('No vocabulary found for the selected categories.', 'text-red-500');
                 return;
            }

            const shuffled = shuffle(filteredVocab);
            currentQueue = shuffled.slice(0, finalCount);
            
            currentIndex = 0;
            score = 0;
            streak = 0;
            isAnswered = false;

            // Update UI visibility
            hideAllScreens();
            screens.game.classList.remove('hidden');
            screens.game.classList.add('flex');
            screens.header.classList.remove('hidden');
            
            updateStats();
            loadQuestion();
        }

        function resetGame() {
            // Restart with the current configuration
            startGame(currentQueue.length);
        }
        
        // --- Hint Logic (Now unlimited) ---
        function showHint() {
            if (quizMode !== 'spelling' || isAnswered) return;

            const currentItem = currentQueue[currentIndex];
            const correctAnswer = normalizeText(currentItem.es[0]); // Use first translation as the primary correct answer
            const currentInput = normalizeText(els.input.value);

            // Find the index of the first differing character
            let hintIndex = 0;
            let currentInputClean = normalizeText(els.input.value);
            
            // Find the position where the input deviates from the correct answer
            while (hintIndex < correctAnswer.length && hintIndex < currentInputClean.length && currentInputClean[hintIndex] === correctAnswer[hintIndex]) {
                hintIndex++;
            }

            // Only provide a hint if the user has not completed the correct answer
            if (hintIndex < correctAnswer.length) {
                const charToReveal = correctAnswer[hintIndex];
                
                // Get the original value up to the hint index
                let originalValue = els.input.value.slice(0, hintIndex);
                
                // If the original value was shorter than the hint index, it means there were spaces/punctuation that got normalized.
                // We ensure the new input value is built correctly from the prefix + new character.
                const newInputValue = originalValue + charToReveal;
                
                // Set the new input value and move cursor to the end
                els.input.value = newInputValue;
                els.input.focus();
                els.input.setSelectionRange(newInputValue.length, newInputValue.length);

                alertUser(`Hint used: '${charToReveal}' revealed.`, 'text-blue-500');
            } else if (currentInput === correctAnswer) {
                // Answer is already correct
                alertUser("You already have the correct answer!", 'text-green-500');
            } else {
                 // User has typed something incorrect *after* the correct answer length
                 alertUser("The hint is available when you're stuck on the next required letter.", 'text-amber-500');
            }
        }

        // --- Quiz Flow Logic ---

        function generateMultipleChoiceOptions(currentItem) {
            const correctTranslation = currentItem.es[0];
            
            // Filter the database to only include words from selected categories
            let filteredVocabForDistractors = [];
            selectedCategories.forEach(categoryKey => {
                if (groupedVocab[categoryKey]) {
                    filteredVocabForDistractors.push(...groupedVocab[categoryKey]);
                }
            });
            
            const allTranslations = filteredVocabForDistractors.map(item => item.es[0]);
            
            // Filter out the correct answer and any potential synonyms
            const correctNormalized = currentItem.es.map(s => normalizeText(s));

            const incorrectOptions = allTranslations.filter(ans => {
                const normalizedAns = normalizeText(ans);
                // Only keep options that are NOT one of the correct answers
                return !correctNormalized.includes(normalizedAns);
            });
            
            // Shuffle and pick up to 3 distractors
            const distractors = shuffle(incorrectOptions).slice(0, 3);
            
            // Combine and shuffle the options
            const options = shuffle([correctTranslation, ...distractors]).slice(0, 4); 
            
            // Handle edge case where we might get less than 4 options (e.g., if vocab list is small)
            while (options.length < 4) {
                 // Fallback: If less than 4 options, pad with a generic placeholder
                 if (options.length < 4) options.push('...Missing Option...');
            }

            return options;
        }


        function loadQuestion() {
            if (currentIndex >= currentQueue.length) {
                showResultScreen();
                return;
            }

            const currentItem = currentQueue[currentIndex];
            els.questionWord.textContent = currentItem.en;
            
            // Reset state
            isAnswered = false;
            els.messageArea.textContent = '';
            els.feedbackIcon.classList.add('hidden');
            els.submitBtn.classList.remove('hidden');
            els.nextBtn.classList.add('hidden');
            
            // Hint button state is no longer managed here as it's unlimited

            if (quizMode === 'spelling') {
                els.mcContainer.classList.add('hidden');
                els.spellingContainer.classList.remove('hidden');
                els.input.value = '';
                els.input.focus();
                // Ensure hint button is visible only in spelling mode
                els.hintBtn.classList.remove('hidden');
            } else { // Multiple Choice
                els.spellingContainer.classList.add('hidden');
                els.mcContainer.classList.remove('hidden');
                // Hide hint button in MC mode
                els.hintBtn.classList.add('hidden');

                renderMultipleChoice(currentItem);
            }

            updateStats();
        }

        function renderMultipleChoice(currentItem) {
            const options = generateMultipleChoiceOptions(currentItem);
            els.mcContainer.innerHTML = options.map((option, index) => `
                <button data-answer="${option}" onclick="selectMultipleChoice(this, '${option}')"
                    class="mc-option w-full bg-white border-2 border-slate-200 text-slate-800 text-lg font-medium rounded-xl p-4 text-center focus:outline-none transition-all">
                    ${option}
                </button>
            `).join('');
        }
        
        let selectedMCOption = null;

        function selectMultipleChoice(button, selectedAnswer) {
            if (isAnswered) return;

            // Clear previous selection highlight
            document.querySelectorAll('.mc-option').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-indigo-300', 'shadow-inner');
            });

            // Highlight current selection
            button.classList.add('ring-4', 'ring-indigo-300', 'shadow-inner');
            selectedMCOption = selectedAnswer;
        }

        function checkAnswer() {
            if (isAnswered) return;

            let isCorrect = false;
            let userAnswer = '';
            let correctAnswerString = '';
            const currentItem = currentQueue[currentIndex];

            if (quizMode === 'spelling') {
                userAnswer = els.input.value;
                const normalizedUserAnswer = normalizeText(userAnswer);
                const correctAnswers = currentItem.es;
                
                isCorrect = correctAnswers.some(ans => normalizeText(ans) === normalizedUserAnswer);
                correctAnswerString = correctAnswers.join(' / ');
                
                // Set the focus back on the input for easy correction
                els.input.focus();

            } else { // Multiple Choice
                if (!selectedMCOption) {
                    alertUser('Please select an option first.', 'text-red-500');
                    return;
                }
                userAnswer = selectedMCOption;
                const correctAnswers = currentItem.es;
                
                isCorrect = correctAnswers.some(ans => normalizeText(ans) === normalizeText(userAnswer));
                correctAnswerString = correctAnswers.join(' / ');

                // Show feedback on buttons
                document.querySelectorAll('.mc-option').forEach(btn => {
                    const optionAnswer = btn.getAttribute('data-answer');
                    if (correctAnswers.some(ans => normalizeText(ans) === normalizeText(optionAnswer))) {
                        btn.classList.add('correct');
                    }
                    if (normalizeText(optionAnswer) === normalizeText(userAnswer) && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                    btn.disabled = true; // Disable all buttons
                });

                // Reset selected option state for next question
                selectedMCOption = null; 
            }

            // --- Common Feedback Logic ---
            isAnswered = true;
            els.submitBtn.classList.add('hidden');
            els.nextBtn.classList.remove('hidden');

            if (isCorrect) {
                score++;
                streak++;
                els.messageArea.className = 'h-16 mt-4 flex items-center justify-center text-center font-medium text-teal-600 bg-teal-50 rounded-lg fade-in';
                els.messageArea.innerHTML = `Â¡Correcto! <i class="fas fa-check-circle ml-2"></i>`;
                els.feedbackIcon.innerHTML = `<i class="fas fa-check-circle text-teal-500"></i>`;
                els.feedbackIcon.classList.remove('hidden');
            } else {
                streak = 0;
                els.messageArea.className = 'h-16 mt-4 flex items-center justify-center text-center font-medium text-red-600 bg-red-50 rounded-lg fade-in';
                els.messageArea.innerHTML = `Â¡Incorrecto! La respuesta correcta es: <span class="font-bold text-indigo-600">${correctAnswerString}</span>`;
                els.feedbackIcon.innerHTML = `<i class="fas fa-times-circle text-red-500"></i>`;
                els.feedbackIcon.classList.remove('hidden');
                shakeInput();
            }

            updateStats();
        }

        function nextQuestion() {
            currentIndex++;
            loadQuestion();
        }

        function showResultScreen() {
            hideAllScreens();
            screens.header.classList.add('hidden');
            screens.result.classList.remove('hidden');
            screens.result.classList.add('flex');

            const totalQuestions = currentQueue.length;
            const accuracy = totalQuestions > 0 ? ((score / totalQuestions) * 100).toFixed(0) : 0;
            
            els.finalScore.textContent = `${score}/${totalQuestions}`;
            els.finalAccuracy.textContent = `${accuracy}%`;

            if (accuracy >= 90) {
                els.resultEmoji.textContent = 'ðŸŒŸ';
            } else if (accuracy >= 70) {
                els.resultEmoji.textContent = 'âœ…';
            } else {
                els.resultEmoji.textContent = 'ðŸ‘';
            }
        }

        // --- Study List Logic ---
        function renderVocabList() {
            els.vocabListContainer.innerHTML = Object.entries(groupedVocab).map(([category, items]) => {
                const listItems = items.map(item => `
                    <div class="flex justify-between items-start py-3 border-b border-slate-100">
                        <span class="text-slate-700 font-medium w-1/2 pr-2">${item.en}</span>
                        <span class="text-indigo-600 font-semibold w-1/2 text-right">${item.es.join(' / ')}</span>
                    </div>
                `).join('');

                return `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <h3 class="text-lg font-bold text-slate-800 mb-2 border-b-2 border-indigo-200 pb-1">${category}</h3>
                        ${listItems}
                    </div>
                `;
            }).join('');
        }

        // --- Accent Helper Logic ---
        function addChar(char) {
            if (quizMode === 'spelling' && !isAnswered) {
                const input = els.input;
                const start = input.selectionStart;
                const end = input.selectionEnd;

                // Insert character at cursor position
                input.value = input.value.substring(0, start) + char + input.value.substring(end);
                
                // Move cursor past the inserted character
                input.focus();
                input.selectionStart = input.selectionEnd = start + 1;
            }
        }

    </script>
</body>
</html>
